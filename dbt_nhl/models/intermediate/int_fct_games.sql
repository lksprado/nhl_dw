with
games_info as (
    select
    game_id,
    season_id,
    game_date,
    start_time_date_eastern,
    start_time_date_gmt_minus_3,
    game_type,
    game_number,
    home_team_id,
    away_team_id,
    home_score,
    away_score
    from {{ ref('stg_csv__all_game_info') }}
),
game_details as (
    select
    game_id,
    referee_1,
    referee_2,
    away_score,
    home_score,
    away_sog,
    home_sog,
    home_score_period_1,
    home_score_period_2,
    home_score_period_3,
    home_score_period_4,
    home_score_period_5,
    away_score_period_1,
    away_score_period_2,
    away_score_period_3,
    away_score_period_4,
    away_score_period_5,
    home_shots_period_1,
    home_shots_period_2,
    home_shots_period_3,
    home_shots_period_4,
    home_shots_period_5,
    away_shots_period_1,
    away_shots_period_2,
    away_shots_period_3,
    away_shots_period_4,
    away_shots_period_5,
    away_hits,
    home_hits,
    away_faceoff_winning_pctg,
    home_faceoff_winning_pctg,
    away_powerplay,
    home_powerplay,
    away_powerplay_pctg,
    home_powerplay_pctg,
    away_penalty_minutes,
    home_penalty_minutes,
    away_blocked_shots,
    home_blocked_shots,
    away_giveaways,
    home_giveaways,
    away_takeaways,
    home_takeaways
    from {{ ref('stg_csv__game_details') }}
),
boxscore_games as (
    select
    game_id,
    arena,
    city,
    outcome_last_period_type,
    outcome_ot_periods,
    away_score,
    home_score,
    away_sog,
    home_sog
    from {{ ref('stg_csv__all_boxscore_games') }}
)
select
t1.game_id,
t1.season_id,
t1.game_date,
t1.start_time_date_eastern,
t1.start_time_date_gmt_minus_3,
t3.arena,
t3.city,
t1.game_type,
t1.game_number,
t3.outcome_last_period_type,
t3.outcome_ot_periods,
t2.referee_1,
t2.referee_2,
t1.home_team_id,
t1.away_team_id,
COALESCE(t1.home_score, t2.home_score, t3.home_score) AS home_score,
COALESCE(t1.away_score, t2.away_score, t3.away_score) AS away_score,
COALESCE(t2.home_sog, t3.home_sog) as home_sog,
COALESCE(t2.away_sog,t3.away_sog) as away_sog,
t2.home_score_period_1,
t2.home_score_period_2,
t2.home_score_period_3,
t2.home_score_period_4,
t2.home_score_period_5,
t2.away_score_period_1,
t2.away_score_period_2,
t2.away_score_period_3,
t2.away_score_period_4,
t2.away_score_period_5,
t2.home_shots_period_1,
t2.home_shots_period_2,
t2.home_shots_period_3,
t2.home_shots_period_4,
t2.home_shots_period_5,
t2.away_shots_period_1,
t2.away_shots_period_2,
t2.away_shots_period_3,
t2.away_shots_period_4,
t2.away_shots_period_5,
t2.away_hits,
t2.home_hits,
t2.away_faceoff_winning_pctg,
t2.home_faceoff_winning_pctg,
t2.away_powerplay_pctg,
t2.home_powerplay_pctg,
t2.away_penalty_minutes,
t2.home_penalty_minutes,
t2.away_blocked_shots,
t2.home_blocked_shots,
t2.away_giveaways,
t2.home_giveaways,
t2.away_takeaways,
t2.home_takeaways
from games_info t1
left join game_details t2
on t1.game_id = t2.game_id
left join boxscore_games t3
on t1.game_id = t3.game_id
order by
t1.season_id desc,
t1.game_number asc
