with
player_info as (
    select
    player_id,
    is_active,
    latest_season,
    pi.position,
    career_pos_assists,
    career_pos_avg_timeonice_seconds,
    career_pos_faceoff_winning_pctg,
    career_pos_games_played,
    career_pos_games_started,
    career_pos_game_winning_goals,
    career_pos_goals,
    career_pos_goals_against,
    career_pos_goals_against_avg,
    career_pos_losses,
    career_pos_ot_goals,
    career_pos_ot_losses,
    career_pos_pim,
    career_pos_plus_minus,
    career_pos_points,
    career_pos_powerplay_goals,
    career_pos_powerplay_points,
    career_pos_save_pctg,
    career_pos_shooting_pctg,
    career_pos_shorthanded_goals,
    career_pos_shorthanded_points,
    career_pos_shots,
    career_pos_shotsagainst,
    career_pos_shutouts,
    career_pos_ties,
    career_pos_timeonice_seconds,
    career_pos_wins,
    career_reg_assists,
    career_reg_avg_timeonice_seconds,
    career_reg_faceoff_winning_pctg,
    career_reg_games_played,
    career_reg_games_started,
    career_reg_game_winning_goals,
    career_reg_goals,
    career_reg_goals_against,
    career_reg_goals_against_avg,
    career_reg_losses,
    career_reg_ot_goals,
    career_reg_ot_losses,
    career_reg_pim,
    career_reg_plus_minus,
    career_reg_points,
    career_reg_powerplay_goals,
    career_reg_powerplay_points,
    career_reg_savepctg,
    career_reg_shootingpctg,
    career_reg_shorthanded_goals,
    career_reg_shorthanded_points,
    career_reg_shots,
    career_reg_shots_against,
    career_reg_shutouts,
    career_reg_ties,
    career_reg_timeonice_seconds,
    career_reg_wins,
    ls_pos_assists,
    ls_pos_games_played,
    ls_pos_game_winning_goals,
    ls_pos_goals,
    ls_pos_goals_against_avg,
    ls_pos_losses,
    ls_pos_ot_goals,
    ls_pos_ot_losses,
    ls_pos_pim,
    ls_pos_plusminus,
    ls_pos_points,
    ls_pos_powerplay_goals,
    ls_pos_powerplay_points,
    ls_pos_save_pctg,
    ls_pos_shooting_pctg,
    ls_pos_shorthanded_goals,
    ls_pos_shorthanded_points,
    ls_pos_shots,
    ls_pos_shutouts,
    ls_pos_ties,
    ls_pos_wins,
    ls_reg_assists,
    ls_reg_games_played,
    ls_reg_game_winning_goals,
    ls_reg_goals,
    ls_reg_goals_against_avg,
    ls_reg_losses,
    ls_reg_ot_goals,
    ls_reg_ot_losses,
    ls_reg_pim,
    ls_reg_plusminus,
    ls_reg_points,
    ls_reg_powerplay_goals,
    ls_reg_powerplay_points,
    ls_reg_save_pctg,
    ls_reg_shooting_pctg,
    ls_reg_shorthanded_goals,
    ls_reg_shorthanded_points,
    ls_reg_shots,
    ls_reg_shutouts,
    ls_reg_ties,
    ls_reg_wins
    from {{ ref('stg_csv__player_info') }} pi
),
player_seasons as (
    select
    player_id,
    season_id,
    rank() over (partition by player_id order by season_id) as seasons_played,
    position_code
    from {{ ref('stg_csv__all_skaters_stats')}}
    union all
    select
    player_id,
    season_id,
    rank() over (partition by player_id order by season_id) as seasons_played,
    position_code
    from {{ ref('stg_csv__all_goalies_stats')}}
)
select
pi.*,
ps.seasons_played
from player_info pi
left join player_seasons ps
on pi.player_id = ps.player_id
and pi.latest_season = ps.season_id
and pi.position = ps.position_code
